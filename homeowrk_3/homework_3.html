<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Istogramma con Chart.js</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .inputs{
            margin-bottom: 10px;
        }
        input{
            margin: auto;
        }
        canvas {
            width: 1000px;
            max-width: 1000px;
            max-height: 600px;
            margin: 20px auto;
        }
        .container {
            margin-bottom: 10px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
        }
        .errore {
            color: red;
            display: none;
        }
    </style>
</head>
<body>
    <div class="inputs">
        <label for="hackers">Hackers (m)</label>
        <input type="number" id="hackers" value="20" min="0">
        <label for="servers">Servers (n)</label>
        <input type="number" id="servers" value="200" min="0">
        <label for="probability">Lambda</label>
        <input type="number" id="lambda" min="0" value="20" onchange="checkLambda();">
        <button id="start" onclick="drawGraph();">Start</button>
        <span id="messaggioErrore" class="errore">Error: Lambda must be lower than n!</span>
    </div>
    <div class="container">
        <canvas id="penetrationChart"></canvas>
        <canvas id="distributionChart"></canvas>
    </div>

    <script>

        let penetrationChartInstance = null;
        let distributionChartInstance = null;

        function simulatePenetrations(n, m, p) {
            let results = [];
            for (let hacker = 0; hacker < m; hacker++) {
                let hackerPenetration = [];
                let cumulativePenetration = 0;
                for (let server = 0; server < n; server++) {
                    let n = Math.random();
                    let penetrated = n <= p ? 1 : 0;
                    cumulativePenetration += penetrated;
                    hackerPenetration.push(cumulativePenetration);
                }
                results.push({ hacker: hacker + 1, penetrations: hackerPenetration, score : cumulativePenetration });
            }
            return results;
        }

        function createPenetrationChart(data) {
            const ctx = document.getElementById('penetrationChart').getContext('2d');
            const labels = Array.from({ length: data[0].penetrations.length }, (_, i) => `Server ${i + 1}`);

            if (penetrationChartInstance) {
                penetrationChartInstance.destroy();
            }

            const datasets = data.map((hackerData, index) => {
                return {
                    label: `Hacker ${hackerData.hacker}`,
                    data: hackerData.penetrations,
                    borderColor: getRandomColor(),
                    fill: false,
                    stepped: true
                };
            });

            penetrationChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Penetration chart'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Penetrations'
                            },
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function createDistributionChart(data) {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            const distribution = Array.from({ length: data[0].penetrations.length + 1 }, () => 0);
            data.forEach(hackerData => {
                const totalSuccesses = hackerData.score;
                distribution[totalSuccesses]++;
            });

            const labels = Array.from({ length: data[0].penetrations.length + 1 }, (_, i) => `${i} Penetrations`);

            if (distributionChartInstance) {
                distributionChartInstance.destroy();
            }

            distributionChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of hackers',
                        data: distribution,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Penetration Frequency chart'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function createAverageChart(data){

        }

        function getRandomColor() {
            const r = Math.floor(Math.random() * 255);
            const g = Math.floor(Math.random() * 255);
            const b = Math.floor(Math.random() * 255);
            return `rgb(${r}, ${g}, ${b})`;
        }

        function drawGraph(){

        const n = parseInt(document.getElementById("servers").value);
        const m = parseInt(document.getElementById("hackers").value);
        const l = parseFloat(document.getElementById("lambda").value);

        const p = l / n;
        console.log(p);

        const simulationResults = simulatePenetrations(n, m, p);

        createPenetrationChart(simulationResults);

        createDistributionChart(simulationResults);  
        }

        function checkLambda(){
            const n = parseInt(document.getElementById("servers").value);
            const l = parseInt(document.getElementById("lambda").value); 
            const messaggioErrore = document.getElementById("messaggioErrore");

            if(l > n){
                document.getElementById("start").disabled = true;
                messaggioErrore.style.display = "block";
            } else{
                document.getElementById("start").disabled = false;
                messaggioErrore.style.display = "none";
            }
        }

        window.onload = function(){
            drawGraph();
        };
        
    </script>
</body>
</html>
